import React, { useState, useRef, useEffect } from 'react';
import styles from './OrderCreateModal.module.css';
import { getUserListBrief, type UserBrief } from '../../../services/dashboard/user/user-detail.service';
import { getAvailableProducts } from '../../../services/products.service';
import type { Product } from '../../../services/products.service';
import { createContract, updateContractTransaction, deleteMinimalContract } from '../../../services/contract.service';
import { toast } from 'react-toastify';
import { useNavigate } from 'react-router-dom';
import ContractFileTypeSelector from '../../../components/contract/ContractFileTypeSelector';
import ContractFileUpload from '../../../components/contract/ContractFileUpload';
import AutoContractGenerator from '../../../components/contract/AutoContractGenerator';
import ManualContractInput from '../../../components/contract/ManualContractInput';
import ContractIdErrorModal from '../../../components/contract/ContractIdErrorModal';

interface OrderCreateModalProps {
  open: boolean;
  onClose: () => void;
  onSuccess?: () => void;
}

const categoryOptions = [
  { value: 'rent', label: '‡∏ú‡πà‡∏≠‡∏ô' },
  { value: 'cash_purchase', label: '‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' },
];
const statusOptions = [
  { value: 'active', label: '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' },
  { value: 'closed', label: '‡∏õ‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤' },
  { value: 'default', label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' },
  { value: 'repossessed', label: '‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô' },
  { value: 'returned', label: '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
  { value: 'hold_by_system', label: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á' },
];

const OrderCreateModal: React.FC<OrderCreateModalProps> = ({ open, onClose, onSuccess }) => {
  const [form, setForm] = useState({
    user_id: '',
    product_id: '',
    category: 'rent',
    total_price: '',
    total_with_interest: '',
    installment_months: '',
    monthly_payment: '',
    status: 'active',
    start_date: '',
    end_date: '',
    pdpa_consent_file: null as File | null,
    user_name: '',
    down_payment_amount: '',
    rental_cost: '',
  });
  const fileInputRef = useRef<HTMLInputElement | null>(null);
  const [userQuery, setUserQuery] = useState('');
  const [showUserList, setShowUserList] = useState(false);
  const userInputRef = useRef<HTMLInputElement | null>(null);
  const [userList, setUserList] = useState<UserBrief[]>([]);
  const [userLoading, setUserLoading] = useState(false);
  const [productList, setProductList] = useState<Product[]>([]);
  const [productLoading, setProductLoading] = useState(false);
  const [productQuery, setProductQuery] = useState('');
  const [showProductList, setShowProductList] = useState(false);
  const productInputRef = useRef<HTMLInputElement | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [contractFileType, setContractFileType] = useState<'upload' | 'auto' | 'manual'>('upload');
  const [autoGeneratedPdfBlob, setAutoGeneratedPdfBlob] = useState<Blob | null>(null);
  const [autoGeneratedContractId, setAutoGeneratedContractId] = useState<string | null>(null);
  const [manualContractId, setManualContractId] = useState<string>('');
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [confirmModalConfig, setConfirmModalConfig] = useState<{
    title: string;
    message: string;
    onConfirm: () => void;
    confirmText: string;
    cancelText: string;
  } | null>(null);
  const [showContractIdErrorModal, setShowContractIdErrorModal] = useState(false);
  const navigate = useNavigate();

  useEffect(() => {
    if (!open) return;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÜ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÅ‡∏Ñ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà)
    const isModalActuallyOpen = document.querySelector(`.${styles.modalBackdrop}`) !== null;
    if (!isModalActuallyOpen) return;
    
    setUserLoading(true);
    getUserListBrief()
      .then(data => setUserList(data ?? []))
      .catch(() => setUserList([]))
      .finally(() => setUserLoading(false));
    setProductLoading(true);
    getAvailableProducts()
      .then(data => setProductList(data ?? []))
      .catch(() => setProductList([]))
      .finally(() => setProductLoading(false));

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö localStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á
    const pendingContractId = localStorage.getItem('pendingMinimalContractId');
    if (pendingContractId) {
      setAutoGeneratedContractId(pendingContractId);
      // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
      toast.info(`‡∏û‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ñ‡πâ‡∏≤‡∏á: ${pendingContractId}`, {
        autoClose: 5000,
        position: "top-center"
      });
    }

    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å field ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î modal
    const todayStr = new Date().toISOString().slice(0, 10);
    setForm({
      user_id: '',
      product_id: '',
      category: 'rent',
      total_price: '',
      total_with_interest: '',
      installment_months: '',
      monthly_payment: '',
      status: 'active',
      start_date: todayStr,
      end_date: '',
      pdpa_consent_file: null,
      user_name: '',
      down_payment_amount: '',
      rental_cost: '',
    });
    setUserQuery('');
    setProductQuery('');
    setShowUserList(false);
    setShowProductList(false);
    setContractFileType('upload');
    setAutoGeneratedPdfBlob(null);
    // ‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï autoGeneratedContractId ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô localStorage
    if (!pendingContractId) {
      setAutoGeneratedContractId(null);
    }
    setManualContractId('');
  }, [open]);

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° useEffect ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ localStorage
  useEffect(() => {
    // ‡πÄ‡∏Å‡πá‡∏ö contract ID ‡πÉ‡∏ô localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ
    if (autoGeneratedContractId) {
      localStorage.setItem('pendingMinimalContractId', autoGeneratedContractId);
    }
    // ‡πÑ‡∏°‡πà‡∏•‡∏ö localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠ autoGeneratedContractId ‡πÄ‡∏õ‡πá‡∏ô null
    // ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö localStorage ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API
  }, [autoGeneratedContractId]);

  useEffect(() => {
    if (form.category === 'cash_purchase') {
      setForm(prev => ({ ...prev, user_id: '', user_name: '' }));
      setUserQuery('');
    }
  }, [form.category]);

  // ‡πÉ‡∏´‡πâ end_date auto update ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà start_date ‡∏´‡∏£‡∏∑‡∏≠ installment_months ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  useEffect(() => {
    if (!open) return;
    if (form.start_date && form.installment_months) {
      setForm(prev => ({
        ...prev,
        end_date: calcEndDate(form.start_date, form.installment_months)
      }));
    }
  }, [form.start_date, form.installment_months, open]);

  if (!open) return null;

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
  function calcEndDate(start: string, months: string) {
    if (!start || !months) return '';
    const d = new Date(start);
    const m = parseInt(months, 10);
    if (isNaN(m)) return '';
    d.setMonth(d.getMonth() + m);
    // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ yyyy-MM-dd
    return d.toISOString().slice(0, 10);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
  function calculateMonthlyPayment(rentalCost: number, installmentMonths: number): string {
    if (isNaN(rentalCost) || isNaN(installmentMonths) || installmentMonths <= 0) {
      return '';
    }
    
    // ‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô = ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î
    // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏à‡πà‡∏≤‡∏¢‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏≠‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡πÉ‡∏ä‡πâ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∂‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏ô
    return (rentalCost / installmentMonths).toFixed(2);
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ PDF blob ‡∏à‡∏≤‡∏Å AutoContractGenerator
  const handlePdfGenerated = (blob: Blob, contractId?: string) => {
    setAutoGeneratedPdfBlob(blob);
    if (contractId) {
      setAutoGeneratedContractId(contractId);
    }
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
  const showConfirmDialog = (config: {
    title: string;
    message: string;
    onConfirm: () => void;
    confirmText?: string;
    cancelText?: string;
  }) => {
    setConfirmModalConfig({
      ...config,
      confirmText: config.confirmText || '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
      cancelText: config.cancelText || '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    });
    setShowConfirmModal(true);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï PDF blob ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå
  const handleContractFileTypeChange = async (type: 'upload' | 'auto' | 'manual') => {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å auto ‡πÑ‡∏õ upload ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    if (contractFileType === 'auto' && type === 'upload' && autoGeneratedContractId) {
      showConfirmDialog({
        title: '‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        message: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏≠‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏î‡∏¥‡∏°\n‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ PUT ‡πÅ‡∏ó‡∏ô POST ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        onConfirm: () => {
          setShowConfirmModal(false);
          setConfirmModalConfig(null);
          performContractFileTypeChange(type);
        },
        confirmText: '‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠',
        cancelText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      });
      return;
    }
    
    performContractFileTypeChange(type);
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
  const performContractFileTypeChange = async (type: 'upload' | 'auto' | 'manual') => {
    setContractFileType(type);
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏ß‡πâ
    if (type === 'upload') {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏ö PDF ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
      setAutoGeneratedPdfBlob(null);
      
      // ‡πÑ‡∏°‡πà‡∏•‡∏ö minimal contract ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö PUT
      // if (autoGeneratedContractId) {
      //   await deleteMinimalContract(autoGeneratedContractId);
      //   console.log('‡∏•‡∏ö minimal contract ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', autoGeneratedContractId);
      //   localStorage.removeItem('pendingMinimalContractId');
      //   setAutoGeneratedContractId(null);
      // }
      
      toast.info('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠)');
    } else if (type === 'auto') {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ
      setForm(prev => ({ ...prev, pdpa_consent_file: null }));
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
      toast.info('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà');
    } else if (type === 'manual') {
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞ PDF ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
      setForm(prev => ({ ...prev, pdpa_consent_file: null }));
      setAutoGeneratedPdfBlob(null);
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
      toast.info('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà');
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    if (name === 'down_payment_amount') {
      setForm(prev => {
        const newForm = { ...prev, [name]: value.replace(/[^\d.]/g, '') };
        // auto-calc rental_cost ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
        const totalWithInterest = parseFloat(newForm.total_with_interest);
        const downPayment = parseFloat(newForm.down_payment_amount);
        if (!isNaN(totalWithInterest) && !isNaN(downPayment)) {
          newForm.rental_cost = (totalWithInterest - downPayment).toFixed(2);
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
          const rentalCost = parseFloat(newForm.rental_cost);
          const installmentMonths = parseInt(newForm.installment_months, 10);
          newForm.monthly_payment = calculateMonthlyPayment(rentalCost, installmentMonths);
        } else {
          newForm.rental_cost = '';
          newForm.monthly_payment = '';
        }
        return newForm;
      });
      return;
    }
    if (name === 'total_with_interest') {
      setForm(prev => {
        const newForm = { ...prev, [name]: value };
        // auto-calc rental_cost ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö
        const totalWithInterest = parseFloat(value);
        const downPayment = parseFloat(newForm.down_payment_amount);
        if (!isNaN(totalWithInterest) && !isNaN(downPayment)) {
          newForm.rental_cost = (totalWithInterest - downPayment).toFixed(2);
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà
          const rentalCost = parseFloat(newForm.rental_cost);
          const installmentMonths = parseInt(newForm.installment_months, 10);
          newForm.monthly_payment = calculateMonthlyPayment(rentalCost, installmentMonths);
        } else {
          newForm.rental_cost = '';
          newForm.monthly_payment = '';
        }
        return newForm;
      });
      return;
    }
    if (name === 'category' && value === 'cash_purchase') {
      setForm(prev => ({
        ...prev,
        [name]: value,
        status: 'closed',
        total_with_interest: '',
        installment_months: '',
        monthly_payment: '',
        start_date: '',
        end_date: '',
        pdpa_consent_file: null
      }));
    } else if (name === 'category') {
      setForm(prev => ({ ...prev, [name]: value, status: 'active' }));
    } else if (name === 'installment_months') {
      if (parseInt(value, 10) > 24) {
        setForm(prev => ({ ...prev, [name]: '' }));
        toast.error('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 24 ‡∏á‡∏ß‡∏î');
        return;
      }
      setForm(prev => {
        const newForm = { ...prev, [name]: value };
        const rentalCost = parseFloat(newForm.rental_cost);
        const installmentMonths = parseInt(value, 10);
        newForm.monthly_payment = calculateMonthlyPayment(rentalCost, installmentMonths);
        // auto ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì end_date
        newForm.end_date = calcEndDate(newForm.start_date || new Date().toISOString().slice(0, 10), value);
        return newForm;
      });
    } else if (name === 'start_date') {
      setForm(prev => {
        const newForm = { ...prev, [name]: value };
        newForm.end_date = calcEndDate(value, newForm.installment_months);
        return newForm;
      });
    } else {
      setForm(prev => ({ ...prev, [name]: value }));
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      
      setForm(prev => ({ ...prev, pdpa_consent_file: file }));
      toast.success(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå "${file.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (isSubmitting) return;
    setIsSubmitting(true);
    
    // validate
    const isCashPurchase = form.category === 'cash_purchase';
    const isRent = form.category === 'rent';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ PUT ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    // ‡∏Å‡∏£‡∏ì‡∏µ PUT: ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (auto ‡∏°‡∏µ autoGeneratedContractId, manual ‡∏°‡∏µ manualContractId)
    // ‡∏Å‡∏£‡∏ì‡∏µ POST: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà) - upload, auto (‡πÑ‡∏°‡πà‡∏°‡∏µ contractId)
    if (isRent) {
      const hasAutoContractId = contractFileType === 'auto' && autoGeneratedContractId;
      const hasManualContractId = contractFileType === 'manual' && manualContractId.trim();
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (PUT)
      if (hasAutoContractId) {
        // ‡∏Å‡∏£‡∏ì‡∏µ PUT: ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (auto)
      } else if (hasManualContractId) {
        // ‡∏Å‡∏£‡∏ì‡∏µ PUT: ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß (manual)
      } else if (contractFileType === 'auto' || contractFileType === 'manual') {
        // ‡∏Å‡∏£‡∏ì‡∏µ PUT: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡πÅ‡∏™‡∏î‡∏á modal
        setIsSubmitting(false);
        setShowContractIdErrorModal(true);
        return;
      }
      // ‡∏Å‡∏£‡∏ì‡∏µ POST: ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (upload, auto ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ contractId ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
    }
    
    // validate
    let requiredFields: (string | File | null)[] = [];
    if (isRent) {
      requiredFields = [
        form.user_id,
        form.product_id,
        form.category,
        form.total_price,
        form.total_with_interest,
        form.installment_months,
        form.monthly_payment,
        form.status,
        form.start_date,
        form.end_date
      ];
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      if (contractFileType === 'upload') {
        requiredFields.push(form.pdpa_consent_file);
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á
        if (!form.pdpa_consent_file) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á)');
          setIsSubmitting(false);
          return;
        }
      } else if (contractFileType === 'auto') {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (!autoGeneratedPdfBlob) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)');
          setIsSubmitting(false);
          return;
        }
      } else if (contractFileType === 'manual') {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
        if (!manualContractId.trim()) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)');
          setIsSubmitting(false);
          return;
        }
        if (!form.pdpa_consent_file) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)');
          setIsSubmitting(false);
          return;
        }
      }
    } else if (isCashPurchase) {
      requiredFields = [
        form.product_id,
        form.category,
        form.total_price
      ];
    }
    
    if (requiredFields.some(field => !field)) {
      toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
      setIsSubmitting(false);
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤
    if (isRent) {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
      const numericChecks = [
        { field: form.total_price, name: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
        { field: form.total_with_interest, name: '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢' },
        { field: form.installment_months, name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î' },
        { field: form.monthly_payment, name: '‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' }
      ];

      for (const check of numericChecks) {
        if (isNaN(Number(check.field)) || Number(check.field) <= 0) {
          toast.error(`${check.name} ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0`);
          setIsSubmitting(false);
          return;
        }
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î
      const installmentMonths = Number(form.installment_months);
      if (installmentMonths > 24) {
        toast.error('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 24 ‡∏á‡∏ß‡∏î');
        setIsSubmitting(false);
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
      const startDate = new Date(form.start_date);
      const endDate = new Date(form.end_date);
      if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
        toast.error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        setIsSubmitting(false);
        return;
      }
      if (startDate >= endDate) {
        toast.error('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
        setIsSubmitting(false);
        return;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const totalPrice = Number(form.total_price);
      const totalWithInterest = Number(form.total_with_interest);
      if (totalWithInterest < totalPrice) {
        toast.error('‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
        setIsSubmitting(false);
        return;
      }

      const monthlyPayment = Number(form.monthly_payment);
      const calculatedMonthly = (totalWithInterest - (Number(form.down_payment_amount) || 0)) / installmentMonths;
      if (Math.abs(monthlyPayment - calculatedMonthly) > 1) { // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô 1 ‡∏ö‡∏≤‡∏ó
        toast.error('‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ');
        setIsSubmitting(false);
        return;
      }
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° payload
    const payload: Record<string, unknown> = {};
    
    if (isCashPurchase) {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
      payload.product_id = form.product_id;
      payload.category = form.category;
      payload.total_price = Number(form.total_price);
      payload.total_with_interest = Number(form.total_price);
      payload.installment_months = 1;
      payload.monthly_payment = 0;
      payload.status = 'active';
      // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î ‡πÉ‡∏™‡πà‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      const todayStr = `${yyyy}-${mm}-${dd}`;
      payload.start_date = todayStr;
      payload.end_date = todayStr;
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå pdpa_consent_file
      // ‡∏ñ‡πâ‡∏≤ user_id ‡πÄ‡∏õ‡πá‡∏ô string ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏•‡∏ö property ‡∏≠‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡πÑ‡∏õ backend)
      if (form.user_id && form.user_id !== '') {
        payload.user_id = form.user_id;
      }
    } else if (isRent) {
      // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô
      payload.user_id = form.user_id;
      payload.product_id = form.product_id;
      payload.category = form.category;
      payload.total_price = Number(form.total_price);
      payload.total_with_interest = Number(form.total_with_interest);
      payload.installment_months = Number(form.installment_months);
      payload.monthly_payment = Number(form.monthly_payment);
      payload.status = form.status;
      payload.start_date = form.start_date;
      payload.end_date = form.end_date;
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤
      if (form.down_payment_amount !== '') {
        payload.down_payment_amount = Number(form.down_payment_amount);
      }
      if (form.rental_cost !== '') {
        payload.rental_cost = Number(form.rental_cost);
      }
      
      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      if (contractFileType === 'upload') {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå
        if (!form.pdpa_consent_file) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
          setIsSubmitting(false);
          return;
        }
        payload.pdpa_consent_file = form.pdpa_consent_file;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (autoGeneratedContractId) {
          // ‡πÉ‡∏ä‡πâ PUT request (‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
          try {
            const res = await updateContractTransaction(autoGeneratedContractId, payload);
            let id: string | undefined;
            if (res && typeof res.data === 'object' && res.data !== null && 'id' in res.data && typeof (res.data as Record<string, unknown>).id === 'string') {
              id = (res.data as Record<string, unknown>).id as string;
            }
            toast.success('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            // ‡∏•‡∏ö localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            localStorage.removeItem('pendingMinimalContractId');
            setTimeout(() => {
              if (id) {
                navigate(`/admin/orders/${id}`);
              } else {
                onClose();
              }
              setIsSubmitting(false);
            }, 800);
            if (onSuccess) onSuccess();
            return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å function ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
          } catch {
            toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
            setIsSubmitting(false);
            return;
          }
        } else {
          // ‡πÉ‡∏ä‡πâ POST request (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠)
          try {
            const res = await createContract(payload);
            // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ any
            let id: string | undefined;
            if (res && typeof res.data === 'object' && res.data !== null && 'id' in res.data && typeof (res.data as Record<string, unknown>).id === 'string') {
              id = (res.data as Record<string, unknown>).id as string;
            }
            toast.success('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            // ‡∏•‡∏ö localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            localStorage.removeItem('pendingMinimalContractId');
            setTimeout(() => {
              if (id) {
                navigate(`/admin/orders/${id}`);
              } else {
                onClose();
              }
              setIsSubmitting(false);
            }, 800);
            if (onSuccess) onSuccess();
            return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å function ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
          } catch {
            toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
            setIsSubmitting(false);
            return;
          }
        }
      } else if (contractFileType === 'auto') {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (!autoGeneratedPdfBlob) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)');
          setIsSubmitting(false);
          return;
        }
        // ‡πÅ‡∏õ‡∏•‡∏á blob ‡πÄ‡∏õ‡πá‡∏ô File object
        const pdfFile = new File([autoGeneratedPdfBlob], `contract-${Date.now()}.pdf`, {
          type: 'application/pdf'
        });
        payload.pdpa_consent_file = pdfFile;
        
        // ‡πÉ‡∏ä‡πâ PUT request (‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß)
        try {
          const res = await updateContractTransaction(autoGeneratedContractId!, payload);
          let id: string | undefined;
          if (res && typeof res.data === 'object' && res.data !== null && 'id' in res.data && typeof (res.data as Record<string, unknown>).id === 'string') {
            id = (res.data as Record<string, unknown>).id as string;
          }
          toast.success('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          // ‡∏•‡∏ö localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          localStorage.removeItem('pendingMinimalContractId');
          setTimeout(() => {
            if (id) {
              navigate(`/admin/orders/${id}`);
            } else {
              onClose();
            }
            setIsSubmitting(false);
          }, 800);
          if (onSuccess) onSuccess();
          return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å function ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        } catch {
          toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
          setIsSubmitting(false);
          return;
        }
      } else if (contractFileType === 'manual') {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
        if (!manualContractId.trim()) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)');
          setIsSubmitting(false);
          return;
        }
        if (!form.pdpa_consent_file) {
          toast.error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á)');
          setIsSubmitting(false);
          return;
        }
        payload.pdpa_consent_file = form.pdpa_consent_file;

        // ‡πÉ‡∏ä‡πâ PUT request ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö manual type
        try {
          const res = await updateContractTransaction(manualContractId, payload);
          let id: string | undefined;
          if (res && typeof res.data === 'object' && res.data !== null && 'id' in res.data && typeof (res.data as Record<string, unknown>).id === 'string') {
            id = (res.data as Record<string, unknown>).id as string;
          }
          toast.success('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          localStorage.removeItem('pendingMinimalContractId');
          setTimeout(() => {
            if (id) {
              navigate(`/admin/orders/${id}`);
            } else {
              onClose();
            }
            setIsSubmitting(false);
          }, 800);
          if (onSuccess) onSuccess();
          return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å function ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        } catch {
          toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
          setIsSubmitting(false);
          return;
        }
      }
    }
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô number ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (form.down_payment_amount !== '') payload.down_payment_amount = Number(form.down_payment_amount);
    if (form.rental_cost !== '') payload.rental_cost = Number(form.rental_cost);
    
    // ‡∏Å‡∏£‡∏ì‡∏µ POST (‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà) - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    try {
      const res = await createContract(payload);
      // ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ any
      let id: string | undefined;
      if (res && typeof res.data === 'object' && res.data !== null && 'id' in res.data && typeof (res.data as Record<string, unknown>).id === 'string') {
        id = (res.data as Record<string, unknown>).id as string;
      }
      toast.success('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      // ‡∏•‡∏ö localStorage ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
      localStorage.removeItem('pendingMinimalContractId');
      setTimeout(() => {
        if (id) {
          navigate(`/admin/orders/${id}`);
        } else {
          onClose();
        }
        setIsSubmitting(false);
      }, 800);
      if (onSuccess) onSuccess();
    } catch {
      toast.error('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
      setIsSubmitting(false);
    }
  };

  const filteredUsers = userList.filter(u =>
    (u.first_name + ' ' + u.phone_number).toLowerCase().includes(userQuery.toLowerCase())
  );

  const handleUserSelect = (user: UserBrief) => {
    setForm(prev => ({ ...prev, user_id: user.id, user_name: user.first_name }));
    setUserQuery(user.first_name + ' (' + user.phone_number + ')');
    setShowUserList(false);
  };

  const filteredProducts = productList.filter(p =>
    (p.id + ' ' + p.model_name).toLowerCase().includes(productQuery.toLowerCase())
  );
  const handleProductSelect = (product: Product) => {
    const todayStr = new Date().toISOString().slice(0, 10);
    setForm(prev => {
      const newStart = todayStr;
      const newEnd = calcEndDate(newStart, prev.installment_months || '');
      return {
        ...prev,
        product_id: product.id,
        total_price: product.price.toString(),
        total_with_interest: product.price.toString(),
        start_date: newStart,
        end_date: newEnd
      };
    });
    setProductQuery(product.id + ' - ' + product.model_name);
    setShowProductList(false);
  };

  const handleClose = async () => {
    // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    if (autoGeneratedContractId) {
      showConfirmDialog({
        title: '‚ö†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô',
        message: `‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${autoGeneratedContractId} ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏´‡∏≤‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å\n\n‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏≠‡∏á"\n\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        onConfirm: async () => {
          setShowConfirmModal(false);
          setConfirmModalConfig(null);
          
          // ‡∏•‡∏ö minimal contract ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
          if (autoGeneratedContractId) {
            try {
              const response = await deleteMinimalContract(autoGeneratedContractId);
              // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö
              if (response && response.status === 200) {
                console.log('‡∏•‡∏ö minimal contract ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', autoGeneratedContractId);
                toast.success(`‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${autoGeneratedContractId})`);
                // ‡∏•‡∏ö localStorage ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ API ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                localStorage.removeItem('pendingMinimalContractId');
                // ‡∏•‡∏ö flag ‡∏Å‡∏≤‡∏£‡∏•‡∏ö
                localStorage.removeItem('isDeletingMinimalContract');
              } else {
                console.warn('API ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ 200:', response?.status);
                toast.warning(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÑ‡∏î‡πâ (${autoGeneratedContractId}) - ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${response?.status}`);
                // ‡πÑ‡∏°‡πà‡∏•‡∏ö localStorage ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
              }
            } catch (error) {
              console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö minimal contract ‡πÑ‡∏î‡πâ:', error);
              toast.error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ (${autoGeneratedContractId})`);
              // ‡πÑ‡∏°‡πà‡∏•‡∏ö localStorage ‡∏ñ‡πâ‡∏≤ API error
            }
          }
          onClose();
        },
        confirmText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á',
        cancelText: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'
      });
      return;
    }
    
    onClose();
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const hasValidFile = () => {
    if (form.category === 'cash_purchase') {
      return true; // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
    }
    
    if (contractFileType === 'upload') {
      return !!form.pdpa_consent_file;
    } else if (contractFileType === 'auto') {
      return !!autoGeneratedPdfBlob;
    } else if (contractFileType === 'manual') {
      return !!form.pdpa_consent_file && !!manualContractId.trim();
    }
    
    return false;
  };

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏£ disable ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isSubmitDisabled = () => {
    return isSubmitting || !hasValidFile();
  };

  return (
    <div className={styles.modalBackdrop}>
      <div className={styles.modalContent}>
        <button className={styles.closeBtn} onClick={handleClose} aria-label="‡∏õ‡∏¥‡∏î">√ó</button>
        <h2 className={styles.title}>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</h2>
        <form onSubmit={handleSubmit} className={styles.form} autoComplete="off">
          <div style={{ position: 'relative' }}>
            <label>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span className={styles.required}>*</span></label>
            <input
              type="text"
              name="user_name"
              value={userQuery}
              onChange={e => {
                setUserQuery(e.target.value);
                setShowUserList(true);
                setForm(prev => ({ ...prev, user_id: '', user_name: e.target.value }));
              }}
              onFocus={() => setShowUserList(true)}
              onBlur={() => setShowUserList(false)}
              ref={userInputRef}
              className={styles.inputBox}
              placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..."
              autoComplete="off"
              required
              disabled={form.category === 'cash_purchase'}
              style={form.category === 'cash_purchase' ? { background: '#e5e7eb', color: '#64748b', cursor: 'not-allowed' } : {}}
            />
            {showUserList && filteredUsers.length > 0 && (
              <div style={{
                position: 'absolute',
                top: '100%', left: 0, right: 0, zIndex: 20,
                background: '#fff', border: '1.5px solid #bae6fd', borderRadius: 8,
                boxShadow: '0 2px 12px #bae6fd22',
                maxHeight: 180, overflowY: 'auto', marginTop: 2
              }}>
                {userLoading ? (
                  <div style={{ padding: '10px 14px', color: '#64748b' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                ) : filteredUsers.map(u => (
                  <div
                    key={u.id}
                    style={{ padding: '10px 14px', cursor: 'pointer', color: '#0ea5e9', fontWeight: 500 }}
                    onMouseDown={() => handleUserSelect(u)}
                  >{u.first_name} <span style={{color:'#64748b',fontWeight:400}}>({u.phone_number})</span></div>
                ))}
              </div>
            )}
            {!userLoading && userList.length === 0 && (
              <div style={{
                position: 'absolute',
                top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(30,41,59,0.72)',
                color: '#fff',
                zIndex: 30,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: 18,
                fontWeight: 600,
                borderRadius: 8
              }}>
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              </div>
            )}
            {form.user_id && (
              <a
                href={`/admin/customers/${form.user_id}`}
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'inline-block',
                  marginTop: 8,
                  color: '#0ea5e9',
                  fontWeight: 600,
                  fontSize: 15,
                  textDecoration: 'underline',
                  cursor: 'pointer',
                  background: 'none',
                  border: 'none',
                  padding: 0
                }}
              >‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
            )}
          </div>
          <div style={{ position: 'relative' }}>
            <label>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span className={styles.required}>*</span></label>
            <input
              type="text"
              name="product_name"
              value={productQuery}
              onChange={e => {
                setProductQuery(e.target.value);
                setShowProductList(true);
                setForm(prev => ({ ...prev, product_id: '' }));
              }}
              onFocus={() => setShowProductList(true)}
              onBlur={() => setShowProductList(false)}
              ref={productInputRef}
              className={styles.inputBox}
              placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
              autoComplete="off"
              required
            />
            {showProductList && filteredProducts.length > 0 && (
              <div style={{
                position: 'absolute',
                top: '100%', left: 0, right: 0, zIndex: 20,
                background: '#fff', border: '1.5px solid #bae6fd', borderRadius: 8,
                boxShadow: '0 2px 12px #bae6fd22',
                maxHeight: 180, overflowY: 'auto', marginTop: 2
              }}>
                {productLoading ? (
                  <div style={{ padding: '10px 14px', color: '#64748b' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                ) : filteredProducts.map(p => (
                  <div
                    key={p.id}
                    style={{ padding: '10px 14px', cursor: 'pointer', color: '#0ea5e9', fontWeight: 500 }}
                    onMouseDown={() => handleProductSelect(p)}
                  >{p.id} - {p.model_name}</div>
                ))}
              </div>
            )}
            {!productLoading && productList.length === 0 && (
              <div style={{
                position: 'absolute',
                top: 0, left: 0, right: 0, bottom: 0,
                background: 'rgba(30,41,59,0.72)',
                color: '#fff',
                zIndex: 30,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                fontSize: 18,
                fontWeight: 600,
                borderRadius: 8
              }}>
                ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              </div>
            )}
            {form.product_id && (
              <a
                href={`/admin/products/${form.product_id}`}
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'inline-block',
                  marginTop: 8,
                  color: '#0ea5e9',
                  fontWeight: 600,
                  fontSize: 15,
                  textDecoration: 'underline',
                  cursor: 'pointer',
                  background: 'none',
                  border: 'none',
                  padding: 0
                }}
              >‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
            )}
          </div>
          <div>
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó <span className={styles.required}>*</span></label>
            <select name="category" value={form.category} onChange={handleChange} required className={styles.inputBox}>
              {categoryOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
            </select>
          </div>
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <span className={styles.required}>*</span></label>
            <input name="total_price" type="number" value={form.total_price} onChange={handleChange} 
              required min={0} className={styles.inputBox} 
            />
          </div>
          {form.category === 'rent' && (
            <>
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ <span className={styles.required}>*</span></label>
            <input name="total_with_interest" type="number" value={form.total_with_interest} onChange={handleChange} 
              required min={0} className={styles.inputBox} 
            />
          </div>
          <div>
            <label>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå <span className={styles.required}>*</span></label>
            <input name="down_payment_amount" type="number" value={form.down_payment_amount} onChange={handleChange}
              min={0} className={styles.inputBox}
              required />
          </div>
          <div>
            <label>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
            <input name="rental_cost" type="number" value={form.rental_cost} readOnly disabled
              min={0} className={styles.inputBox}
              placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" />
          </div>
          <div>
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô <span className={styles.required}>*</span></label>
            <input name="installment_months" type="number" value={form.installment_months} onChange={handleChange}
              required min={1} max={24} className={styles.inputBox}
            />
          </div>
          <div>
            <label>‡∏¢‡∏≠‡∏î‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô <span className={styles.required}>*</span></label>
            <input name="monthly_payment" type="number" value={form.monthly_payment} onChange={handleChange} 
              required min={0} step="0.01" className={styles.inputBox} 
            />
            <div style={{ 
              fontSize: '12px', 
              color: '#64748b', 
              marginTop: '4px',
              fontStyle: 'italic'
            }}>
              üí° ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å: ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î
            </div>
          </div>
          <div>
            <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <span className={styles.required}>*</span></label>
            <select
              name="status"
              value={form.status}
              onChange={handleChange}
              required
              className={styles.inputBox}
            >
              {statusOptions.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
            </select>
          </div>
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° <span className={styles.required}>*</span></label>
            <input name="start_date" type="date" value={form.start_date} onChange={handleChange} 
              required className={styles.inputBox} 
            />
          </div>
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span className={styles.required}>*</span></label>
            <input name="end_date" type="date" value={form.end_date} onChange={handleChange} 
              required className={styles.inputBox} 
            />
          </div>
          <ContractFileTypeSelector 
            selectedType={contractFileType}
            onTypeChange={handleContractFileTypeChange}
          />
          
          {/* ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ */}
          {autoGeneratedContractId && (
            <div style={{ 
              padding: '12px 16px', 
              background: '#f0f9ff', 
              border: '1px solid #bae6fd', 
              borderRadius: '8px',
              marginBottom: '16px'
            }}>
              <div style={{ 
                display: 'flex', 
                alignItems: 'center', 
                gap: '8px',
                color: '#0ea5e9',
                fontWeight: '600',
                fontSize: '14px',
                marginBottom: '4px'
              }}>
                <span style={{ fontSize: '16px' }}>üìã</span>
                ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
              </div>
              <div style={{ 
                color: '#64748b', 
                fontSize: '13px',
                fontFamily: 'monospace',
                background: '#fff',
                padding: '6px 10px',
                borderRadius: '4px',
                border: '1px solid #e2e8f0'
              }}>
                {autoGeneratedContractId}
              </div>
              <div style={{ 
                fontSize: '12px', 
                color: '#64748b', 
                marginTop: '6px',
                fontStyle: 'italic'
              }}>
                üí° ‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
              </div>
              <div style={{ 
                fontSize: '11px', 
                color: '#f59e0b', 
                marginTop: '4px',
                fontWeight: '500'
              }}>
                ‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏≠‡∏á"
              </div>
            </div>
          )}
          
          {contractFileType === 'upload' && (
            <ContractFileUpload
              file={form.pdpa_consent_file}
              onFileChange={handleFileChange}
              fileInputRef={fileInputRef}
              hasExistingContractId={!!autoGeneratedContractId}
            />
          )}
          {contractFileType === 'auto' && (
            <AutoContractGenerator 
              contractData={form} 
              onPdfGenerated={handlePdfGenerated}
              existingContractId={autoGeneratedContractId}
            />
          )}
          {contractFileType === 'manual' && (
            <ManualContractInput
              contractId={manualContractId}
              onContractIdChange={setManualContractId}
              onFileChange={handleFileChange}
              file={form.pdpa_consent_file}
              fileInputRef={fileInputRef}
            />
          )}
            </>
          )}
          <div className={styles.buttonRow}>
            <button type="submit" className={styles.submitBtn} disabled={isSubmitDisabled()}>
              {isSubmitting ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : (
                !hasValidFile() ? '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå' : (
                  contractFileType === 'manual' ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : (
                    autoGeneratedContractId && contractFileType === 'upload' ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'
                  )
                )
              )}
            </button>
            <button type="button" className={styles.cancelBtn} onClick={handleClose}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </form>
      </div>
      {showConfirmModal && confirmModalConfig && (
        <div className={styles.confirmModalBackdrop}>
          <div className={styles.confirmModalContent}>
            <div style={{ 
              fontSize: '48px', 
              marginBottom: '16px',
              color: '#ef4444'
            }}>
              ‚ö†Ô∏è
            </div>
            <h3>{confirmModalConfig.title}</h3>
            <p style={{ 
              whiteSpace: 'pre-line',
              textAlign: 'center',
              background: '#f8fafc',
              padding: '16px',
              borderRadius: '8px',
              border: '1px solid #e2e8f0',
              fontSize: '14px',
              lineHeight: '1.6'
            }}>
              {confirmModalConfig.message}
            </p>
            <div className={styles.confirmModalButtons}>
              <button 
                onClick={() => {
                  setShowConfirmModal(false);
                  setConfirmModalConfig(null);
                }} 
                className={styles.cancelBtn}
                style={{ background: '#f3f4f6', color: '#374151', border: '1px solid #d1d5db' }}
              >
                {confirmModalConfig.cancelText}
              </button>
              <button 
                onClick={confirmModalConfig.onConfirm} 
                className={styles.confirmBtn}
                style={{ 
                  background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                  color: '#fff',
                  boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)'
                }}
              >
                {confirmModalConfig.confirmText}
              </button>
            </div>
          </div>
        </div>
      )}
      {showContractIdErrorModal && (
        <ContractIdErrorModal
          open={showContractIdErrorModal}
          onClose={() => setShowContractIdErrorModal(false)}
          onSwitchToManual={() => {
            setContractFileType('manual');
            setManualContractId('');
            setForm(prev => ({ ...prev, pdpa_consent_file: null }));
            if (fileInputRef.current) {
              fileInputRef.current.value = '';
            }
          }}
        />
      )}
    </div>
  );
};

export default OrderCreateModal; 