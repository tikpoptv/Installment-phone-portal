import React, { useEffect, useState } from 'react';
import { useParams, useNavigate, Link } from 'react-router-dom';
import styles from './OrderDetailPage.module.css';
import { getContractDetail, getContractPayments, getPdpaConsentFile } from '../../../services/contract.service';
import { updateContractStatus } from '../../../services/contract.service';
import type { ContractDetail, ContractPayment, Installment, Discount } from '../../../services/contract.service';
import PaymentDetailModal from '../payments/PaymentDetailModal';
import DiscountModal from './DiscountModal';
import { MdCheckCircle, MdRadioButtonUnchecked, MdPending, MdAutorenew, MdCancel, MdLock } from 'react-icons/md';
import PaymentCreateModal from '../payments/PaymentCreateModal';

function formatDate(dateStr: string) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return date.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á status ‡∏Ç‡∏≠‡∏á installment
function getInstallmentStatusLabel(status: string): string {
  switch (status) {
    case 'paid': return '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
    case 'unpaid': return '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞';
    case 'partial': return '‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
    case 'skipped': return '‡∏Ç‡πâ‡∏≤‡∏°‡∏á‡∏ß‡∏î';
    case 'final_payment': return '‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î';
    default: return status;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CSS class ‡∏Ç‡∏≠‡∏á status
function getInstallmentStatusClass(status: string): string {
  switch (status) {
    case 'paid': return styles.statusPaid;
    case 'unpaid': return styles.statusUnpaid;
    case 'partial': return styles.statusPartial;
    case 'skipped': return styles.statusSkipped;
    case 'final_payment': return styles.statusFinalPayment;
    default: return styles.statusUnpaid;
  }
}

// ‡∏ô‡∏≥ statusMap ‡πÅ‡∏•‡∏∞ statusOptions ‡∏à‡∏≤‡∏Å OrderListPage ‡∏°‡∏≤‡πÉ‡∏ä‡πâ
const statusMap: Record<string, { label: string; color: string; icon?: React.ReactNode }> = {
  active: { label: '‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡∏≠‡∏¢‡∏π‡πà', color: '#0ea5e9', icon: <MdCheckCircle color="#22c55e" size={18} style={{verticalAlign:'middle'}} /> },
  closed: { label: '‡∏õ‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤', color: '#22c55e', icon: <MdRadioButtonUnchecked color="#64748b" size={18} style={{verticalAlign:'middle'}} /> },
  overdue: { label: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞', color: '#ef4444', icon: <MdCancel color="#ef4444" size={18} style={{verticalAlign:'middle'}} /> },
  repossessed: { label: '‡∏¢‡∏∂‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', color: '#a21caf', icon: <MdLock color="#a21caf" size={18} style={{verticalAlign:'middle'}} /> },
  processing: { label: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', color: '#f59e42', icon: <MdAutorenew color="#d97706" size={18} style={{verticalAlign:'middle'}} /> },
  returned: { label: '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', color: '#6366f1', icon: <MdRadioButtonUnchecked color="#6366f1" size={18} style={{verticalAlign:'middle'}} /> },
  hold_by_system: { label: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á', color: '#8b5cf6', icon: <MdLock color="#8b5cf6" size={18} style={{verticalAlign:'middle'}} /> },
  default: { label: '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞', color: '#ef4444', icon: <MdCancel color="#ef4444" size={18} style={{verticalAlign:'middle'}} /> },
};

const categoryMap: Record<string, { label: string; emoji: string }> = {
  rent: { label: '‡∏ú‡πà‡∏≠‡∏ô', emoji: 'üì±' },
  buy: { label: '‡∏ã‡∏∑‡πâ‡∏≠', emoji: 'üí∏' },
  cash_purchase: { label: '‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', emoji: 'üíµ' },
};

// Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
const statusOptions = [
  { value: 'closed', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' },
  { value: 'repossessed', label: '‡∏¢‡∏∂‡∏î‡∏Ñ‡∏∑‡∏ô' },
  { value: 'returned', label: '‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' },
];

interface OrderStatusEditModalProps {
  open: boolean;
  onClose: () => void;
  currentStatus: string;
  onSubmit: (status: string) => void;
}

const OrderStatusEditModal: React.FC<OrderStatusEditModalProps> = ({ open, onClose, currentStatus, onSubmit }) => {
  const [status, setStatus] = useState(currentStatus);
  useEffect(() => {
    const found = statusOptions.find(opt => opt.value === currentStatus);
    if (found) {
      setStatus(currentStatus);
    } else {
      setStatus('closed'); // default ‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"
    }
  }, [currentStatus]);
  if (!open) return null;
  return (
    <div className={styles.modalOverlay}>
      <div className={styles.modalContent} style={{ maxWidth: 400, minWidth: 280 }}>
        <div className={styles.modalHeader}>
          <span>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</span>
          <button className={styles.closeBtn} onClick={onClose} aria-label="‡∏õ‡∏¥‡∏î">√ó</button>
        </div>
        <div className={styles.modalBody}>
          <label style={{ fontWeight: 600, color: '#0ea5e9', marginBottom: 10, display: 'block' }}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà</label>
          <select
            className={styles.select}
            value={status}
            onChange={e => setStatus(e.target.value)}
            style={{ width: '100%', padding: '10px 12px', borderRadius: 8, fontSize: '1.08rem', marginBottom: 18 }}
          >
            {statusOptions.map(opt => (
              <option key={opt.value} value={opt.value}>{opt.label}</option>
            ))}
          </select>
        </div>
        <div className={styles.modalFooter}>
          <button className={styles.downloadBtn} style={{ background: '#e0e7ef', color: '#0ea5e9' }} onClick={onClose}>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button className={styles.downloadBtn} style={{ background: '#0ea5e9', color: '#fff' }} onClick={() => onSubmit(status)}>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      </div>
    </div>
  );
};

// Modal ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö
function SystemHoldWarningModal({ open, onClose }: { open: boolean; onClose: () => void }) {
  if (!open) return null;
  
  return (
    <div style={{
      position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh',
      background: 'rgba(0,0,0,0.8)', zIndex: 99999, display: 'flex', alignItems: 'center', justifyContent: 'center',
      padding: 12, backdropFilter: 'blur(20px)', WebkitBackdropFilter: 'blur(20px)'
    }}>
      <div style={{
        background: 'linear-gradient(135deg, #fff 80%, #f8fafc 100%)',
        borderRadius: 24,
        padding: '40px 32px 32px 32px',
        maxWidth: 520,
        width: '100%',
        textAlign: 'center',
        position: 'relative',
        boxShadow: '0 20px 60px rgba(0,0,0,0.3), 0 8px 32px rgba(139, 92, 246, 0.2)',
        border: '2px solid #e9d5ff',
        animation: 'modalSlideIn 0.3s ease-out'
      }}>
        <button
          onClick={onClose}
          style={{
            position: 'absolute', top: 16, right: 16, background: 'none', border: 'none',
            fontSize: 28, color: '#8b5cf6', cursor: 'pointer', borderRadius: '50%', width: 40, height: 40,
            transition: 'background 0.15s', fontWeight: 700, display: 'flex', alignItems: 'center', justifyContent: 'center'
          }}
          aria-label="‡∏õ‡∏¥‡∏î"
          onMouseOver={e => (e.currentTarget.style.background = '#f3f4f6')}
          onMouseOut={e => (e.currentTarget.style.background = 'none')}
        >√ó</button>
        
        <div style={{ 
          fontSize: 64, 
          marginBottom: 20, 
          filter: 'drop-shadow(0 4px 16px rgba(139, 92, 246, 0.3))',
          animation: 'pulse 2s ease-in-out infinite'
        }}>
          üîí
        </div>
        
        <div style={{ 
          fontWeight: 900, 
          fontSize: '1.5rem', 
          color: '#8b5cf6', 
          marginBottom: 16, 
          letterSpacing: 0.5 
        }}>
          ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á
        </div>
        
        <div style={{ 
          color: '#475569', 
          fontSize: '1.1rem', 
          marginBottom: 24, 
          lineHeight: 1.7, 
          fontWeight: 500 
        }}>
          ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ <strong style={{ color: '#8b5cf6' }}>"‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á"</strong><br/>
          <span style={{ color: '#64748b', fontSize: '1rem' }}>
            ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ
          </span>
        </div>
        
        <div style={{
          background: 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)',
          borderRadius: 12,
          padding: '16px 20px',
          marginBottom: 28,
          border: '1px solid #d1d5db'
        }}>
          <div style={{ 
            color: '#374151', 
            fontSize: '0.95rem', 
            fontWeight: 600,
            marginBottom: 8 
          }}>
            ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:
          </div>
          <ul style={{ 
            color: '#6b7280', 
            fontSize: '0.9rem', 
            textAlign: 'left',
            margin: 0,
            paddingLeft: 20,
            lineHeight: 1.6
          }}>
            <li>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
            <li>‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
            <li>‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</li>
            <li>‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
          </ul>
        </div>
        
        <button
          style={{
            background: 'linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%)', 
            color: '#fff', 
            border: 'none', 
            borderRadius: 16,
            padding: '16px 40px', 
            fontWeight: 800, 
            fontSize: '1.1rem', 
            cursor: 'pointer', 
            boxShadow: '0 4px 16px rgba(139, 92, 246, 0.3)',
            letterSpacing: 0.5, 
            transition: 'all 0.2s',
            minWidth: 160
          }}
          onClick={onClose}
          onMouseOver={e => {
            e.currentTarget.style.transform = 'translateY(-2px)';
            e.currentTarget.style.boxShadow = '0 6px 20px rgba(139, 92, 246, 0.4)';
          }}
          onMouseOut={e => {
            e.currentTarget.style.transform = 'translateY(0)';
            e.currentTarget.style.boxShadow = '0 4px 16px rgba(139, 92, 246, 0.3)';
          }}
        >
          ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
        </button>
      </div>
    </div>
  );
}

const OrderDetailPage: React.FC = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const [contract, setContract] = useState<ContractDetail | null>(null);
  const [payments, setPayments] = useState<ContractPayment[]>([]);
  const [installments, setInstallments] = useState<Installment[]>([]);
  const [discounts, setDiscounts] = useState<Discount[]>([]);
  const [remainingAmount, setRemainingAmount] = useState<number>(0);
  const [overdueMonths, setOverdueMonths] = useState<number>(0);
  const [totalDueThisMonth, setTotalDueThisMonth] = useState<number>(0);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [paymentLoading, setPaymentLoading] = useState(true);
  const [paymentError, setPaymentError] = useState<string | null>(null);
  const [showPdpaModal, setShowPdpaModal] = useState(false);
  const [pdpaBlobUrl, setPdpaBlobUrl] = useState<string | null>(null);
  const [pdpaLoading, setPdpaLoading] = useState(false);
  const [pdpaError, setPdpaError] = useState<string | null>(null);
  const [showPaymentDetailModal, setShowPaymentDetailModal] = useState(false);
  const [selectedPaymentId, setSelectedPaymentId] = useState<string | null>(null);
  const [showAddDiscountModal, setShowAddDiscountModal] = useState(false);
  const [showInstallmentDetailModal, setShowInstallmentDetailModal] = useState(false);
  const [selectedInstallment, setSelectedInstallment] = useState<Installment | null>(null);
  const [showDiscountDetailModal, setShowDiscountDetailModal] = useState(false);
  const [selectedDiscount, setSelectedDiscount] = useState<Discount | null>(null);
  const [showEditStatusModal, setShowEditStatusModal] = useState(false);
  const [showCreatePaymentModal, setShowCreatePaymentModal] = useState(false);
  const [showCreatePaymentTooltip, setShowCreatePaymentTooltip] = useState(false);
  const [showSystemHoldWarning, setShowSystemHoldWarning] = useState(false);

  useEffect(() => {
    if (!id) return;
    setLoading(true);
    setError(null);
    getContractDetail(id)
      .then(data => setContract(data))
      .catch(() => setError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'))
      .finally(() => setLoading(false));
  }, [id]);

  useEffect(() => {
    if (!id) return;
    setPaymentLoading(true);
    setPaymentError(null);
    getContractPayments(id)
      .then(data => {
        setPayments(data.payments ?? []);
        setInstallments(data.installments ?? []);
        setDiscounts(data.discounts ?? []);
        setRemainingAmount(data.remaining_amount ?? 0);
        setOverdueMonths(data.overdue_months ?? 0);
        setTotalDueThisMonth(data.total_due_this_month ?? 0);
      })
      .catch(() => setPaymentError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'))
      .finally(() => setPaymentLoading(false));
  }, [id]);

  // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö
  useEffect(() => {
    if (contract && contract.status === 'hold_by_system') {
      setShowSystemHoldWarning(true);
    }
  }, [contract]);

  const handleShowPdpaModal = async () => {
    setPdpaLoading(true);
    setPdpaError(null);
    setShowPdpaModal(true);
    try {
      const blob = await getPdpaConsentFile(
        contract?.id as string,
        contract?.pdpa_consent_file_filename as string
      );
      const url = URL.createObjectURL(blob);
      setPdpaBlobUrl(url);
    } catch (e) {
      setPdpaError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ');
      console.error(e);
    } finally {
      setPdpaLoading(false);
    }
  };

  const handleClosePdpaModal = () => {
    setShowPdpaModal(false);
    if (pdpaBlobUrl) {
      URL.revokeObjectURL(pdpaBlobUrl);
    }
    setPdpaBlobUrl(null);
    setPdpaError(null);
    setPdpaLoading(false);
  };

  if (loading) return <div className={styles.container}><div className={styles.contentBox}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>;
  if (error || !contract) return <div className={styles.container}><div className={styles.contentBox}>{error || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'}</div></div>;

  const o = contract;
  const status = statusMap[o.status] || { label: o.status, color: '', icon: null };
  const category = categoryMap[o.category] || { label: o.category, emoji: '' };

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö
  const isSystemHold = o.status === 'hold_by_system';
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const canCreatePayment = (o.status === 'active' || o.status === 'default') && !isSystemHold;

  return (
    <div className={styles.container}>
      <SystemHoldWarningModal 
        open={showSystemHoldWarning} 
        onClose={() => {
          setShowSystemHoldWarning(false);
          // ‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ list ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Modal
          navigate('/admin/orders');
        }} 
      />
      <div className={styles.contentBox}>
        <div className={styles.topBar}>
          <button className={styles.backBtn} onClick={() => navigate(-1)} title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö">‚Üê</button>
          <div className={styles.title}>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
          <button
            className={styles.addDiscountBtn}
            style={{ 
              marginLeft: 'auto', 
              background: isSystemHold ? '#f3f4f6' : 'linear-gradient(90deg,#22c55e,#0ea5e9)', 
              color: isSystemHold ? '#6b7280' : '#fff', 
              fontWeight: 700, 
              border: 'none', 
              borderRadius: 8, 
              padding: '8px 18px', 
              fontSize: 16, 
              cursor: isSystemHold ? 'not-allowed' : 'pointer', 
              boxShadow: isSystemHold ? 'none' : '0 2px 8px #bae6fd55', 
              transition: 'background 0.18s',
              opacity: isSystemHold ? 0.6 : 1
            }}
            onClick={() => {
              if (isSystemHold) {
                setShowSystemHoldWarning(true);
              } else {
                setShowAddDiscountModal(true);
              }
            }}
            disabled={isSystemHold}
          >
            + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î
          </button>
        </div>
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle}>üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
            <span
              className={styles.badge}
              style={{ background: (status.color || '#64748b') + '22', color: status.color || '#64748b' }}
            >
              {status.icon} {status.label}
            </span>
            <div className={styles.editOrderBtnWrapper}>
              <button
                className={styles.editOrderBtn}
                type="button"
                disabled={o.status === 'closed' || isSystemHold}
                onClick={() => {
                  if (isSystemHold) {
                    setShowSystemHoldWarning(true);
                  } else {
                    setShowEditStatusModal(true);
                  }
                }}
                style={{
                  ...(isSystemHold && {
                    background: '#f3f4f6',
                    color: '#6b7280',
                    cursor: 'not-allowed',
                    opacity: 0.6
                  })
                }}
              >
                ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              {(o.status === 'closed' || isSystemHold) && (
                <div className={styles.editOrderBtnTooltip}>
                  {o.status === 'closed' 
                    ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"'
                    : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á"'
                  }
                </div>
              )}
            </div>
          </div>
          <div className={styles.section}><div className={styles.label}>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:</div><div className={styles.value}>{o.id}</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</div><div className={styles.value}>{category.emoji} {category.label} ({o.category})</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</div><div className={styles.value}>{formatDate(o.start_date)}</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</div><div className={styles.value}>{formatDate(o.end_date)}</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</div><div className={styles.value}>{formatDate(o.last_payment_date || '')}</div></div>
        </div>
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle}>üôç‚Äç‚ôÇÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</div>
          <div className={styles.section}><div className={styles.label}>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</div><div className={styles.value}>{o.user ? `${o.user.first_name} ${o.user.last_name}` : '-'}</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:</div><div className={styles.value}>{o.user ? o.user.id : '-'}</div></div>
          {o.user && <Link className={styles.linkBtn} to={`/admin/customers/${o.user.id}`}>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡πà‡∏≤</Link>}
        </div>
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle}>üì¶ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <div className={styles.section}><div className={styles.label}>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô:</div><div className={styles.value}>{o.product ? o.product.model_name : '-'}</div></div>
          <div className={styles.section}><div className={styles.label}>Serial Number:</div><div className={styles.value}>{o.product ? o.product.imei : '-'}</div></div>
          <div className={styles.section}><div className={styles.label}>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤:</div><div className={styles.value}>{o.product ? o.product.price.toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) : '-'}</div></div>
          {o.product && <Link className={styles.linkBtn} to={`/admin/products/${o.product.id}`}>‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</Link>}
        </div>
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle}>üí≥ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div>
          {o.category === 'cash_purchase' ? (
            <>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢):</div><div className={styles.value}>{o.total_price.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢):</div><div className={styles.value}></div></div>
              <div className={styles.section}><div className={styles.label}>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå:</div><div className={styles.value}></div></div>
              <div className={styles.section}><div className={styles.label}>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô:</div><div className={styles.value}></div></div>
              <div className={styles.section}><div className={styles.label}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î:</div><div className={styles.value}></div></div>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</div><div className={styles.value}></div></div>
            </>
          ) : (
            <>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢):</div><div className={styles.value}>{o.total_price.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢):</div><div className={styles.value}>{o.total_with_interest.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
              <div className={styles.section}><div className={styles.label}>‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå:</div><div className={styles.value}>{typeof o.down_payment_amount === 'number' ? o.down_payment_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) : '-'}</div></div>
              <div className={styles.section}><div className={styles.label}>‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤/‡∏ú‡πà‡∏≠‡∏ô:</div><div className={styles.value}>{typeof o.rental_cost === 'number' ? o.rental_cost.toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) : '-'}</div></div>
              <div className={styles.section}><div className={styles.label}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î:</div><div className={styles.value}>{o.installment_months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></div>
              <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</div><div className={styles.value}>{o.monthly_payment.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
              {!paymentLoading && !paymentError && (
                <>
                  <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</div><div className={styles.value} style={{ color: remainingAmount > 0 ? '#ef4444' : '#22c55e', fontWeight: 600 }}>{remainingAmount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
                  <div className={styles.section}><div className={styles.label}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞:</div><div className={styles.value} style={{ color: overdueMonths > 0 ? '#ef4444' : '#22c55e', fontWeight: 600 }}>{overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</div></div>
                  <div className={styles.section}><div className={styles.label}>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</div><div className={styles.value} style={{ color: totalDueThisMonth > 0 ? '#ef4444' : '#22c55e', fontWeight: 600 }}>{totalDueThisMonth.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</div></div>
                </>
              )}
            </>
          )}
        </div>
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle}>üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
          {o.pdpa_consent_file_filename ? (
            <button
              className={styles.linkBtn}
              type="button"
              onClick={handleShowPdpaModal}
            >
              ‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤
            </button>
          ) : (
            <div className={styles.value}>-</div>
          )}
        </div>
        {showPdpaModal && (
          <div className={styles.modalOverlay}>
            <div className={styles.modalContent}>
              <div className={styles.modalHeader}>
                <span>‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
                <button className={styles.closeBtn} onClick={handleClosePdpaModal} aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
              </div>
              <div className={styles.modalBody}>
                {pdpaLoading ? (
                  <div style={{ padding: 32, textAlign: 'center' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå...</div>
                ) : pdpaError ? (
                  <div style={{ color: '#ef4444', padding: 32 }}>{pdpaError}</div>
                ) : pdpaBlobUrl ? (
                  <iframe
                    src={pdpaBlobUrl}
                    title="Contract File"
                    width="100%"
                    height="500px"
                    style={{ border: '1px solid #ddd', borderRadius: 8 }}
                  />
                ) : null}
              </div>
              <div className={styles.modalFooter}>
                {pdpaBlobUrl && (
                  <a
                    href={pdpaBlobUrl}
                    download={o.pdpa_consent_file_filename}
                    className={styles.downloadBtn}
                  >
                    ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
                  </a>
                )}
              </div>
            </div>
          </div>
        )}
        <div className={styles.sectionCard}>
          <div className={styles.sectionTitle} style={{display:'flex',alignItems:'center',justifyContent:'space-between'}}>
            <span>üí∞ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span>
            <div style={{ position: 'relative', display: 'inline-block' }}>
              <button
                className={styles.addDiscountBtn}
                style={{ 
                  background: canCreatePayment ? 'linear-gradient(90deg,#0ea5e9,#22c55e)' : '#f3f4f6', 
                  color: canCreatePayment ? '#fff' : '#6b7280', 
                  fontWeight: 700, 
                  border: 'none', 
                  borderRadius: 8, 
                  padding: '7px 18px', 
                  fontSize: 15, 
                  cursor: canCreatePayment ? 'pointer' : 'not-allowed', 
                  boxShadow: canCreatePayment ? '0 2px 8px #bae6fd55' : 'none', 
                  transition: 'background 0.18s', 
                  opacity: canCreatePayment ? 1 : 0.6 
                }}
                onClick={() => {
                  if (isSystemHold) {
                    setShowSystemHoldWarning(true);
                  } else if (canCreatePayment) {
                    setShowCreatePaymentModal(true);
                  }
                }}
                disabled={!canCreatePayment}
                onMouseEnter={() => { 
                  if (!canCreatePayment) setShowCreatePaymentTooltip(true); 
                }}
                onMouseLeave={() => setShowCreatePaymentTooltip(false)}
              >
                + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞
              </button>
              {!canCreatePayment && showCreatePaymentTooltip && (
                <div style={{ position: 'absolute', top: '100%', left: 0, background: '#334155', color: '#fff', fontSize: 13, borderRadius: 6, padding: '6px 14px', marginTop: 6, whiteSpace: 'nowrap', zIndex: 10, boxShadow: '0 2px 8px #33415555' }}>
                  {isSystemHold 
                    ? '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡∏£‡∏∞‡∏ö‡∏ö‡∏ñ‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≠‡∏á"'
                    : '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏õ‡πá‡∏ô "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞"'
                  }
                </div>
              )}
            </div>
          </div>
          {!paymentLoading && !paymentError && (
            <PaymentAlerts contract={o} payments={payments} installments={installments} remainingAmount={remainingAmount} overdueMonths={overdueMonths} totalDueThisMonth={totalDueThisMonth} />
          )}
          {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Installments */}
          {!paymentLoading && !paymentError && installments.length > 0 && (
            <div style={{marginBottom: 18}}>
              <div className={styles.sectionSubtitle}>üìÜ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô</div>
              <div style={{ overflowX: 'auto', width: '100%' }}>
                <table className={styles.paymentTable} style={{marginBottom: 8}}>
                  <thead>
                    <tr>
                      <th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th>
                      <th>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th>
                      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                      <th className={styles.categoryCol}>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                      <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {installments.map(inst => (
                      <tr key={inst.id}>
                        <td>{inst.installment_number}</td>
                        <td>{formatDate(inst.due_date)}</td>
                        <td>{inst.amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</td>
                        <td className={styles.categoryCol}>
                          <span className={inst.category === 'down_payment' ? styles.categoryDown : styles.categoryRent}>
                            {inst.category === 'down_payment' ? '‡∏î‡∏≤‡∏ß‡∏ô‡πå' : '‡∏ú‡πà‡∏≠‡∏ô'}
                          </span>
                        </td>
                        <td>
                          <span className={`${styles.installmentStatus} ${getInstallmentStatusClass(inst.status)}`}>
                            {getInstallmentStatusLabel(inst.status)}
                          </span>
                        </td>
                        <td>
                          <button 
                            type="button" 
                            className={styles.linkBtn} 
                            onClick={() => { 
                              setSelectedInstallment(inst); 
                              setShowInstallmentDetailModal(true); 
                            }}
                            style={{ fontSize: 12, padding: '3px 8px' }}
                          >
                            ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          {/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Discounts */}
          {!paymentLoading && !paymentError && discounts.length > 0 && (
            <div style={{marginBottom: 18}}>
              <div className={styles.sectionSubtitle}>üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</div>
              <div style={{ overflowX: 'auto', width: '100%' }}>
                <table className={styles.paymentTable} style={{marginBottom: 8}}>
                  <thead>
                    <tr>
                      <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                      <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
                      <th>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                      <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    {discounts.map(ds => {
                      return (
                        <tr key={ds.id}>
                          <td>{ds.discount_type === 'early_closure' ? '‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©'}</td>
                          <td>{ds.discount_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</td>
                          <td>
                            {ds.final_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                          </td>
                          <td>{formatDate(ds.approved_at)}</td>
                          <td>
                            <button 
                              type="button" 
                              className={styles.linkBtn} 
                              onClick={() => { 
                                setSelectedDiscount(ds); 
                                setShowDiscountDetailModal(true); 
                              }}
                              style={{ fontSize: 12, padding: '3px 8px' }}
                            >
                              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </div>
          )}
          {paymentLoading ? (
            <div style={{ padding: 16, color: '#64748b' }}>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
          ) : paymentError ? (
            <div style={{ padding: 16, color: '#ef4444' }}>{paymentError}</div>
          ) : (
            <div className={styles.paymentTableWrapper}>
              <table className={styles.paymentTable}>
                <thead>
                  <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                    <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</th>
                    <th className={styles.statusCell}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {payments.length === 0 ? (
                    <tr>
                      <td colSpan={5} style={{ textAlign: 'center', color: '#ef4444', fontWeight: 600, fontSize: 17, padding: 16 }}>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏£‡∏Å{typeof o.down_payment_amount === 'number' && o.down_payment_amount > 0 ? ` (‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå ${o.down_payment_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })})` : ''}
                      </td>
                    </tr>
                  ) : payments.map(pm => (
                    <tr key={pm.id}>
                      <td>{formatDate(pm.payment_date)}</td>
                      <td>{pm.amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</td>
                      <td>{pm.method === 'bank_transfer' ? '‡πÇ‡∏≠‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£' : pm.method === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : pm.method}</td>
                      <td className={styles.statusCell}>
                        {pm.verify_status === 'approved' ? (
                          <>
                            <MdCheckCircle color="#22c55e" size={18} style={{verticalAlign:'middle', marginRight:4}} /> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
                          </>
                        ) : pm.verify_status === 'rejected' ? (
                          <>
                            <MdCancel color="#ef4444" size={18} style={{verticalAlign:'middle', marginRight:4}} /> ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                          </>
                        ) : (
                          <>
                            <MdPending color="#eab308" size={18} style={{verticalAlign:'middle', marginRight:4}} /> ‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                          </>
                        )}
                      </td>
                      <td>
                        <button 
                          type="button" 
                          className={styles.linkBtn} 
                          onClick={() => { setSelectedPaymentId(pm.id); setShowPaymentDetailModal(true); }}
                          style={{ fontSize: 14, padding: '4px 8px' }}
                        >
                          ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
        <PaymentDetailModal
          open={showPaymentDetailModal}
          paymentId={selectedPaymentId}
          onClose={() => setShowPaymentDetailModal(false)}
          onActionSuccess={() => {
            if (id) {
              setPaymentLoading(true);
              setPaymentError(null);
              getContractPayments(id)
                .then(data => {
                  setPayments(data.payments ?? []);
                  setInstallments(data.installments ?? []);
                  setDiscounts(data.discounts ?? []);
                  setRemainingAmount(data.remaining_amount ?? 0);
                  setOverdueMonths(data.overdue_months ?? 0);
                  setTotalDueThisMonth(data.total_due_this_month ?? 0);
                })
                .catch(() => setPaymentError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'))
                .finally(() => setPaymentLoading(false));
            }
          }}
        />
        {showAddDiscountModal && (
          <DiscountModal
            open={showAddDiscountModal}
            onClose={() => setShowAddDiscountModal(false)}
            contractId={o.id}
            rentalCost={typeof o.rental_cost === 'number' ? o.rental_cost : 0}
            discounts={discounts}
            onSuccess={() => {
              setShowAddDiscountModal(false);
              if (id) {
                setPaymentLoading(true);
                setPaymentError(null);
                getContractPayments(id)
                  .then(data => {
                    setPayments(data.payments ?? []);
                    setInstallments(data.installments ?? []);
                    setDiscounts(data.discounts ?? []);
                    setRemainingAmount(data.remaining_amount ?? 0);
                    setOverdueMonths(data.overdue_months ?? 0);
                    setTotalDueThisMonth(data.total_due_this_month ?? 0);
                  })
                  .catch(() => setPaymentError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'))
                  .finally(() => setPaymentLoading(false));
              }
            }}
          />
        )}
        
        {/* Modal ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î‡∏ú‡πà‡∏≠‡∏ô */}
        {showInstallmentDetailModal && selectedInstallment && (
          <div className={styles.modalOverlay}>
            <div className={styles.modalContent}>
              <div className={styles.modalHeader}>
                <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà {selectedInstallment.installment_number}</span>
                <button className={styles.closeBtn} onClick={() => { setShowInstallmentDetailModal(false); setSelectedInstallment(null); }} aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
              </div>
              <div className={styles.modalBody}>
                <div style={{ display: 'grid', gap: '12px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà:</span>
                    <span style={{ fontWeight: 600 }}>{selectedInstallment.installment_number}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span>
                    <span>{formatDate(selectedInstallment.due_date)}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                    <span style={{ fontWeight: 600, color: '#0ea5e9' }}>{selectedInstallment.amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß:</span>
                    <span style={{ fontWeight: 600, color: selectedInstallment.amount_paid > 0 ? '#22c55e' : '#ef4444' }}>
                      {selectedInstallment.amount_paid.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                    <span style={{ fontWeight: 600, color: '#ef4444' }}>
                      {(selectedInstallment.amount - selectedInstallment.amount_paid).toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                    </span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                    <span>
                      <span className={`${styles.installmentStatus} ${getInstallmentStatusClass(selectedInstallment.status)}`}>
                        {getInstallmentStatusLabel(selectedInstallment.status)}
                      </span>
                    </span>
                  </div>
                  {selectedInstallment.paid_at && (
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                      <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏≥‡∏£‡∏∞:</span>
                      <span>{formatDate(selectedInstallment.paid_at)}</span>
                    </div>
                  )}
                  {selectedInstallment.note && (
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                      <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span>
                      <span>{selectedInstallment.note}</span>
                    </div>
                  )}
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</span>
                    <span className={selectedInstallment.category === 'down_payment' ? styles.categoryDown : styles.categoryRent}>
                      {selectedInstallment.category === 'down_payment' ? '‡∏î‡∏≤‡∏ß‡∏ô‡πå' : '‡∏ú‡πà‡∏≠‡∏ô'}
                    </span>
                  </div>
                  {selectedInstallment.is_final_payment && (
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                      <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                      <span style={{ fontWeight: 600, color: '#0ea5e9' }}>‡∏á‡∏ß‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        {showDiscountDetailModal && selectedDiscount && (
          <div className={styles.modalOverlay}>
            <div className={styles.modalContent}>
              <div className={styles.modalHeader}>
                <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©</span>
                <button className={styles.closeBtn} onClick={() => { setShowDiscountDetailModal(false); setSelectedDiscount(null); }} aria-label="‡∏õ‡∏¥‡∏î">&times;</button>
              </div>
              <div className={styles.modalBody}>
                <div style={{ display: 'grid', gap: '12px' }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</span>
                    <span>{selectedDiscount.discount_type === 'early_closure' ? '‡∏õ‡∏¥‡∏î‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î' : '‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡∏û‡∏¥‡πÄ‡∏®‡∏©'}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                    <span style={{ fontWeight: 600, color: '#0ea5e9' }}>{selectedDiscount.discount_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                    <span style={{ fontWeight: 600, color: '#0ea5e9' }}>{selectedDiscount.final_amount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</span>
                    <span>{selectedDiscount.approved_by}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                    <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</span>
                    <span>{formatDate(selectedDiscount.approved_at)}</span>
                  </div>
                  {selectedDiscount.note && (
                    <div style={{ display: 'flex', justifyContent: 'space-between', padding: '8px 0', borderBottom: '1px solid #e5e7eb' }}>
                      <span style={{ fontWeight: 600, color: '#64748b' }}>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span>
                      <span>{selectedDiscount.note}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
        <PaymentCreateModal
          open={showCreatePaymentModal}
          onClose={() => setShowCreatePaymentModal(false)}
          onSuccess={() => {
            setShowCreatePaymentModal(false);
            if (id) {
              setPaymentLoading(true);
              setPaymentError(null);
              getContractPayments(id)
                .then(data => {
                  setPayments(data.payments ?? []);
                  setInstallments(data.installments ?? []);
                  setDiscounts(data.discounts ?? []);
                  setRemainingAmount(data.remaining_amount ?? 0);
                  setOverdueMonths(data.overdue_months ?? 0);
                  setTotalDueThisMonth(data.total_due_this_month ?? 0);
                })
                .catch(() => setPaymentError('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô'))
                .finally(() => setPaymentLoading(false));
            }
          }}
          contractId={o.id}
        />
        <div className={styles.meta}>
          <div>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: {formatDate(o.created_at)}</div>
          <div>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {formatDate(o.updated_at)}</div>
        </div>
      </div>
      {/* Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */}
      <OrderStatusEditModal
        key={showEditStatusModal ? o.status : undefined}
        open={showEditStatusModal}
        onClose={() => setShowEditStatusModal(false)}
        currentStatus={o.status}
        onSubmit={async (newStatus) => {
          if (!id) return;
          setLoading(true);
          try {
            await updateContractStatus(id, newStatus);
            // refresh contract detail
            const data = await getContractDetail(id);
            setContract(data);
          } catch (error) {
            console.error(error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞');
          } finally {
            setLoading(false);
            setShowEditStatusModal(false);
          }
        }}
      />
    </div>
  );
};

function PaymentAlerts({ contract, payments, installments, remainingAmount, overdueMonths, totalDueThisMonth }: { 
  contract: ContractDetail, 
  payments: ContractPayment[],
  installments: Installment[],
  remainingAmount: number,
  overdueMonths: number,
  totalDueThisMonth: number
}) {
  if (!contract) return null;
  const alerts: string[] = [];
  const now = new Date();
  const thisMonth = now.getMonth() + 1;
  const thisYear = now.getFullYear();
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
  if (remainingAmount > 0) {
    alerts.push(`üí∞ ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remainingAmount.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}`);
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞
  if (overdueMonths > 0) {
    alerts.push(`‚ö†Ô∏è ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${overdueMonths} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
  if (totalDueThisMonth > 0) {
    alerts.push(`üìÖ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: ${totalDueThisMonth.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}`);
  }
  
  // ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå - ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å installments ‡∏ó‡∏µ‡πà category ‡πÄ‡∏õ‡πá‡∏ô 'down_payment'
  if (Array.isArray(installments)) {
    const downInstallments = installments.filter(ins => ins.category === 'down_payment');
    if (downInstallments.length > 0) {
      const totalDown = downInstallments.reduce((sum, ins) => sum + (ins.amount || 0), 0);
      const paidDown = downInstallments.reduce((sum, ins) => sum + (ins.amount_paid || 0), 0);
      if (paidDown < totalDown) {
        alerts.push(`‚ö†Ô∏è ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${totalDown.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${paidDown.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${(totalDown - paidDown).toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}`);
      } else {
        alerts.push(`‚úÖ ‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${totalDown.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })})`);
      }
    }
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤)
  let paidThisMonth = 0;
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤
  let isFirstMonth = false;
  if (contract.start_date) {
    const start = new Date(contract.start_date);
    isFirstMonth = (start.getFullYear() === thisYear && start.getMonth() + 1 === thisMonth);
  }
  
  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß
  const approvedPaymentsThisMonth = payments.filter(p => {
    const d = new Date(p.payment_date);
    return d.getMonth() + 1 === thisMonth && 
           d.getFullYear() === thisYear && 
           p.verify_status === 'approved';
  });
  
  paidThisMonth = approvedPaymentsThisMonth.reduce((sum, p) => sum + (p.amount || 0), 0);
  
  if (!isFirstMonth && typeof contract.monthly_payment === 'number' && contract.monthly_payment > 0) {
    if (paidThisMonth < contract.monthly_payment) {
      alerts.push(`‚ö†Ô∏è ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡∏ä‡∏≥‡∏£‡∏∞ ${contract.monthly_payment.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} ‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ${paidThisMonth.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })} ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${ (contract.monthly_payment - paidThisMonth).toLocaleString('th-TH', { style: 'currency', currency: 'THB' }) }`);
    } else {
      alerts.push(`‚úÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß (${contract.monthly_payment.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })})`);
    }
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
  let lastPaidDate: Date | null = null;
  const approvedPayments = payments.filter(p => p.verify_status === 'approved');
  if (approvedPayments.length > 0) {
    lastPaidDate = approvedPayments
      .map(p => new Date(p.payment_date))
      .reduce((latest, d) => (!latest || d > latest ? d : latest), null as Date | null);
  }
  
  if (lastPaidDate) {
    const lastMonth = lastPaidDate.getMonth() + 1;
    const lastYear = lastPaidDate.getFullYear();
    if (lastYear < thisYear || (lastYear === thisYear && lastMonth < thisMonth)) {
      const monthsLate = (thisYear - lastYear) * 12 + (thisMonth - lastMonth);
      if (monthsLate > 0) {
        alerts.push(`‚ö†Ô∏è ‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞ ${monthsLate} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ä‡∏≥‡∏£‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${lastPaidDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' })})`);
      }
    }
  }
  
  if (alerts.length === 0) return null;
  return (
    <div style={{ marginBottom: 12 }}>
      {alerts.map((msg, idx) => (
        <div key={idx} style={{ color: msg.startsWith('‚úÖ') ? '#22c55e' : msg.startsWith('üí∞') ? '#0ea5e9' : '#ef4444', fontWeight: 600, fontSize: 15, marginBottom: 2 }}>{msg}</div>
      ))}
    </div>
  );
}

export default OrderDetailPage; 